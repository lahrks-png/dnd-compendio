<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1f2937">
    <meta name="description" content="Gestisci il tuo compendio di mostri D&D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="D&D Compendio">
    
    <title>Visualizzatore Compendio D&D</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🐉</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🐉</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        #preview-modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #preview-modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        #preview-modal:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }
        
        #toast {
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s 0.5s, opacity 0.5s linear;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.5s linear;
        }
        
        .stat-block {
            background-color: #fdf9f2;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-block hr {
            border: 0;
            border-top: 1px solid #922610;
            height: 1px;
            margin: 8px 0;
        }
        .stat-block h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #922610;
            border-bottom: 1px solid #922610;
            padding-bottom: 4px;
            margin-top: 12px;
        }
        
        /* Evidenziazione valori numerici chiave */
        .highlight-value {
            background-color: #fef3c7;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            color: #92400e;
            display: inline-block;
            margin: 0 2px;
        }
        
        .highlight-damage {
            background-color: #fee2e2;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            color: #991b1b;
            display: inline-block;
            margin: 0 2px;
        }
        
        .highlight-bonus {
            background-color: #dbeafe;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            color: #1e40af;
            display: inline-block;
            margin: 0 2px;
        }

        #mobile-sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        #mobile-sidebar.open {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            button, select, input[type="file"] {
                min-height: 44px;
            }
        }

        /* Install prompt */
        #install-prompt {
            transition: transform 0.3s ease-in-out;
        }
        
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900 antialiased">

    <!-- Install Prompt (PWA) -->
    <div id="install-prompt" class="hidden fixed bottom-0 left-0 right-0 bg-blue-600 text-white p-4 shadow-lg z-50">
        <div class="container mx-auto flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <span class="text-2xl">🐉</span>
                <div>
                    <p class="font-semibold text-sm">Installa l'app</p>
                    <p class="text-xs opacity-90">Accedi rapidamente al tuo compendio</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="install-btn" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium text-sm">
                    Installa
                </button>
                <button id="dismiss-install" class="text-white px-3 py-2">
                    <ion-icon name="close" class="text-xl"></ion-icon>
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-md p-3 md:p-4 sticky top-0 z-20">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <button id="menu-toggle" class="md:hidden text-gray-700 hover:text-blue-600 focus:outline-none">
                    <ion-icon name="menu" class="text-3xl"></ion-icon>
                </button>
                <h1 class="text-lg md:text-2xl font-bold text-gray-800">🐉 Compendio D&D</h1>
            </div>
            <div class="text-xs text-gray-500 hidden sm:block">
                User: <span id="user-id" class="font-mono">...</span>
            </div>
        </div>
    </header>

    <div id="sidebar-overlay" class="hidden md:hidden fixed inset-0 bg-black bg-opacity-50 z-30"></div>

    <div class="flex h-[calc(100vh-60px)] md:h-[calc(100vh-68px)]">
        
        <aside id="mobile-sidebar" class="fixed md:relative w-80 md:w-80 bg-white p-4 shadow-lg overflow-y-auto z-40 h-full">
            <button id="close-sidebar" class="md:hidden absolute top-2 right-2 text-gray-400 hover:text-gray-600">
                <ion-icon name="close" class="text-2xl"></ion-icon>
            </button>

            <div class="mt-2 md:mt-0">
                <label for="xml-uploader" class="block text-sm font-medium text-gray-700 mb-2">Carica XML</label>
                <input id="xml-uploader" type="file" accept=".xml" class="block w-full text-sm text-gray-500
                    file:mr-2 file:py-2 file:px-4
                    file:rounded-lg file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100 cursor-pointer
                "/>
                <div id="db-status" class="mt-2 text-xs text-gray-500"></div>
                <button id="clear-db-btn" class="hidden mt-2 text-xs text-red-600 hover:text-red-800">
                    Elimina database salvato
                </button>
            </div>

            <div class="mt-4 md:mt-6">
                <label for="filter-input" class="block text-sm font-medium text-gray-700 mb-2">Filtra per Nome/Tipo</label>
                <input type="text" id="filter-input" placeholder="Es. Goblin, Drago..." class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                
                <label for="cr-filter-select" class="block text-sm font-medium text-gray-700 mb-2 mt-4">Filtra per GS (CR)</label>
                <select id="cr-filter-select" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                    <option value="">Qualsiasi GS</option>
                    <!-- Le opzioni saranno popolate da JS -->
                </select>
            </div>

            <div class="mt-4 md:mt-6 border border-blue-300 bg-blue-50 p-3 rounded-lg">
                <h2 class="text-base md:text-lg font-semibold text-blue-800 mb-2">Selezione Attuale</h2>
                <ul id="temp-folder-list" class="space-y-1 mb-3 max-h-32 overflow-y-auto text-sm">
                </ul>
                <input type="text" id="temp-folder-name" placeholder="Nome selezione..." class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <div class="flex gap-2 mt-2">
                    <button id="save-temp-folder-btn" class="flex-1 bg-green-600 text-white px-3 py-2.5 rounded-lg font-medium shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Salva
                    </button>
                    <button id="clear-temp-folder-btn" class="flex-1 bg-gray-500 text-white px-3 py-2.5 rounded-lg font-medium shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                        Svuota
                    </button>
                </div>
            </div>

            <div class="mt-4 md:mt-6">
                <h2 class="text-base md:text-lg font-semibold text-gray-800 mb-3">Le mie Cartelle</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="new-folder-name" placeholder="Nome cartella" class="flex-grow p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <button id="create-folder-btn" class="bg-blue-600 text-white px-4 py-2.5 rounded-lg font-medium shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Crea
                    </button>
                </div>
                <ul id="folder-list" class="space-y-2">
                </ul>
                <button id="show-all-btn" class="hidden w-full mt-4 bg-gray-200 text-gray-700 px-4 py-2.5 rounded-lg font-medium shadow-sm hover:bg-gray-300 focus:outline-none">
                    Mostra Tutti
                </button>
            </div>
        </aside>

        <main id="monster-list-container" class="flex-1 p-3 md:p-6 overflow-y-auto bg-gray-50">
            <div id="loading-message" class="text-center text-gray-500 mt-10 px-4">
                <p class="text-base md:text-lg">Carica il file XML per iniziare</p>
            </div>
            
            <div id="folder-info-bar" class="hidden bg-white p-3 md:p-4 rounded-lg shadow-md mb-3 md:mb-4">
                <h3 class="text-lg md:text-xl font-bold text-gray-800" id="folder-info-name">Nome Cartella</h3>
                <p class="text-base md:text-lg text-gray-600" id="folder-info-xp">XP Totale: 0</p>
            </div>
            
            <div id="monster-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 md:gap-4">
            </div>
        </main>
    </div>

    <div id="preview-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center">
        <div class="bg-white rounded-none md:rounded-2xl shadow-2xl w-full h-full md:w-auto md:h-auto md:max-w-4xl md:max-h-[90vh] flex flex-col">
            <div class="flex justify-center items-center p-3 md:p-4 border-b border-gray-200 bg-white sticky top-0 z-10">
                <h2 id="modal-monster-name" class="text-lg md:text-2xl font-bold text-gray-900">Nome Mostro</h2>
            </div>
            
            <div id="modal-monster-content" class="p-4 md:p-6 overflow-y-auto stat-block flex-1 text-sm md:text-base">
            </div>
            
            <div class="p-3 md:p-4 bg-gray-50 border-t border-gray-200 space-y-3 md:space-y-4">
                <div id="add-to-folder-container" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-4">
                    <label for="add-to-folder-select" class="text-sm font-medium text-gray-700 sm:flex-shrink-0">Aggiungi a Cartella:</label>
                    <select id="add-to-folder-select" class="flex-grow p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Scegli cartella...</option>
                    </select>
                </div>
                
                <div class="border-t pt-3 md:pt-4">
                     <button id="add-to-temp-folder-btn" class="w-full bg-blue-600 text-white px-4 py-3 md:py-2.5 rounded-lg font-medium shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:bg-blue-300">
                        Aggiungi alla Selezione
                    </button>
                </div>
                
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-4 md:bottom-10 left-4 right-4 md:left-auto md:right-10 bg-green-600 text-white py-3 px-4 md:px-6 rounded-lg shadow-xl text-base md:text-lg">
        <p id="toast-message">Notifica!</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            setLogLevel, 
            doc, 
            collection, 
            addDoc, 
            updateDoc, 
            deleteDoc,
            onSnapshot, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registrato'))
                    .catch(err => console.log('Errore Service Worker:', err));
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        const installPrompt = document.getElementById('install-prompt');
        const installBtn = document.getElementById('install-btn');
        const dismissInstall = document.getElementById('dismiss-install');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.classList.remove('hidden');
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                installPrompt.classList.add('hidden');
            }
        });

        dismissInstall.addEventListener('click', () => {
            installPrompt.classList.add('hidden');
        });

        let db, auth;
        let userId = null;
        let useLocalStorage = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const apiKey = "";

        const crXpMap = {
            "0": 10, "1/8": 25, "1/4": 50, "1/2": 100,
            "1": 200, "2": 450, "3": 700, "4": 1100, "5": 1800,
            "6": 2300, "7": 2900, "8": 3900, "9": 5000, "10": 5900,
            "11": 7200, "12": 8400, "13": 10000, "14": 11500, "15": 13000,
            "16": 15000, "17": 18000, "18": 20000, "19": 22000, "20": 25000,
            "21": 33000, "22": 41000, "23": 50000, "24": 62000, "25": 75000,
            "26": 90000, "27": 105000, "28": 120000, "29": 135000, "30": 155000,
            "N/A": 0
        };

        let allMonsters = [];
        let currentMonster = null;
        let folders = {};
        let tempMonsterList = [];
        let currentFolderViewId = null;
        
        const uploader = document.getElementById('xml-uploader');
        const filterInput = document.getElementById('filter-input');
        const crFilterSelect = document.getElementById('cr-filter-select');
        const monsterGrid = document.getElementById('monster-grid');
        const loadingMessage = document.getElementById('loading-message');
        const folderInfoBar = document.getElementById('folder-info-bar');
        const folderInfoName = document.getElementById('folder-info-name');
        const folderInfoXp = document.getElementById('folder-info-xp');
        const modal = document.getElementById('preview-modal');
        const modalName = document.getElementById('modal-monster-name');
        const modalContent = document.getElementById('modal-monster-content');
        const userIdSpan = document.getElementById('user-id');
        const newFolderInput = document.getElementById('new-folder-name');
        const createFolderBtn = document.getElementById('create-folder-btn');
        const folderList = document.getElementById('folder-list');
        const addToFolderSelect = document.getElementById('add-to-folder-select');
        const showAllBtn = document.getElementById('show-all-btn');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const tempFolderList = document.getElementById('temp-folder-list');
        const tempFolderInput = document.getElementById('temp-folder-name');
        const saveTempFolderBtn = document.getElementById('save-temp-folder-btn');
        const clearTempFolderBtn = document.getElementById('clear-temp-folder-btn');
        const addToTempFolderBtn = document.getElementById('add-to-temp-folder-btn');
        const menuToggle = document.getElementById('menu-toggle');
        const closeSidebar = document.getElementById('close-sidebar');
        const mobileSidebar = document.getElementById('mobile-sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const dbStatus = document.getElementById('db-status');
        const clearDbBtn = document.getElementById('clear-db-btn');

        function openSidebar() {
            mobileSidebar.classList.add('open');
            sidebarOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebarMenu() {
            mobileSidebar.classList.remove('open');
            sidebarOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        }

        menuToggle.addEventListener('click', openSidebar);
        closeSidebar.addEventListener('click', closeSidebarMenu);
        sidebarOverlay.addEventListener('click', closeSidebarMenu);

        async function setupFirebase() {
            if (!firebaseConfig.apiKey || Object.keys(firebaseConfig).length === 0) {
                console.log('Firebase non configurato, uso localStorage');
                useLocalStorage = true;
                userId = 'local-user';
                userIdSpan.textContent = 'Modalità Locale';
                loadFolders();
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdSpan.textContent = userId;
                        loadFolders();
                    } else {
                        try {
                            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (token) {
                                await signInWithCustomToken(auth, token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Errore di autenticazione:", error);
                        }
                    }
                });
            } catch (error) {
                console.error("Errore inizializzazione Firebase:", error);
                useLocalStorage = true;
                userId = 'local-user';
                userIdSpan.textContent = 'Modalità Locale';
                loadFolders();
            }
        }

        // IndexedDB functions
        let dbIndexed;
        let indexedDBAvailable = false;
        
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    console.log('IndexedDB non supportato');
                    reject(new Error('IndexedDB non supportato'));
                    return;
                }
                
                try {
                    const request = indexedDB.open('DnDCompendiumDB', 1);
                    
                    request.onerror = () => {
                        console.error('Errore apertura IndexedDB:', request.error);
                        reject(request.error);
                    };
                    
                    request.onsuccess = () => {
                        dbIndexed = request.result;
                        indexedDBAvailable = true;
                        console.log('IndexedDB aperto con successo');
                        resolve(dbIndexed);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('monsters')) {
                            db.createObjectStore('monsters', { keyPath: 'id' });
                            console.log('Object store "monsters" creato');
                        }
                    };
                    
                    request.onblocked = () => {
                        console.warn('IndexedDB bloccato');
                        reject(new Error('Database bloccato'));
                    };
                } catch (error) {
                    console.error('Eccezione durante inizializzazione IndexedDB:', error);
                    reject(error);
                }
            });
        }
        
        function saveMonstersToIndexedDB(monsters) {
            if (!indexedDBAvailable || !dbIndexed) {
                return Promise.reject(new Error('IndexedDB non disponibile'));
            }
            
            return new Promise((resolve, reject) => {
                try {
                    const transaction = dbIndexed.transaction(['monsters'], 'readwrite');
                    const store = transaction.objectStore('monsters');
                    
                    store.clear();
                    const putRequest = store.put({ id: 'allMonsters', data: monsters });
                    
                    putRequest.onsuccess = () => {
                        console.log('Mostri salvati in IndexedDB');
                    };
                    
                    putRequest.onerror = () => {
                        console.error('Errore salvataggio mostri:', putRequest.error);
                    };
                    
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                } catch (error) {
                    console.error('Eccezione durante salvataggio:', error);
                    reject(error);
                }
            });
        }
        
        function loadMonstersFromIndexedDB() {
            if (!indexedDBAvailable || !dbIndexed) {
                return Promise.resolve(null);
            }
            
            return new Promise((resolve, reject) => {
                try {
                    const transaction = dbIndexed.transaction(['monsters'], 'readonly');
                    const store = transaction.objectStore('monsters');
                    const request = store.get('allMonsters');
                    
                    request.onsuccess = () => {
                        if (request.result) {
                            console.log('Mostri caricati da IndexedDB:', request.result.data.length);
                            resolve(request.result.data);
                        } else {
                            console.log('Nessun dato trovato in IndexedDB');
                            resolve(null);
                        }
                    };
                    request.onerror = () => {
                        console.error('Errore caricamento mostri:', request.error);
                        reject(request.error);
                    };
                } catch (error) {
                    console.error('Eccezione durante caricamento:', error);
                    reject(error);
                }
            });
        }
        
        function clearSavedMonsters() {
            if (!indexedDBAvailable || !dbIndexed) {
                return Promise.reject(new Error('IndexedDB non disponibile'));
            }
            
            return new Promise((resolve, reject) => {
                try {
                    const transaction = dbIndexed.transaction(['monsters'], 'readwrite');
                    const store = transaction.objectStore('monsters');
                    store.clear();
                    
                    transaction.oncomplete = () => {
                        console.log('Database IndexedDB cancellato');
                        resolve();
                    };
                    transaction.onerror = () => reject(transaction.error);
                } catch (error) {
                    console.error('Eccezione durante cancellazione:', error);
                    reject(error);
                }
            });
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            loadingMessage.textContent = "Caricamento e parsing del file XML...";
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const xmlString = e.target.result;
                    parseXML(xmlString);
                    
                    if (indexedDBAvailable) {
                        try {
                            await saveMonstersToIndexedDB(allMonsters);
                            dbStatus.textContent = `✓ ${allMonsters.length} mostri salvati localmente`;
                            dbStatus.className = 'mt-2 text-xs text-green-600 font-medium';
                            clearDbBtn.classList.remove('hidden');
                            showToast('Database salvato! Non dovrai ricaricarlo.');
                        } catch (error) {
                            console.error('Errore salvataggio IndexedDB:', error);
                            dbStatus.textContent = '⚠ Mostri caricati ma non salvati localmente';
                            dbStatus.className = 'mt-2 text-xs text-orange-600';
                            showToast('Mostri caricati (non salvati localmente)');
                        }
                    } else {
                        dbStatus.textContent = '⚠ Mostri caricati solo in sessione (non salvati)';
                        dbStatus.className = 'mt-2 text-xs text-orange-600';
                        showToast('Mostri caricati (salvataggio non disponibile)');
                    }
                } catch (error) {
                    console.error("Errore durante il parsing:", error);
                    loadingMessage.textContent = "Errore nel leggere o parsare il file XML.";
                }
            };
            
            reader.onerror = () => {
                loadingMessage.textContent = "Impossibile leggere il file.";
            };
            
            reader.readAsText(file);
        }

        function parseXML(xmlString) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "text/xml");
            const monsters = xmlDoc.getElementsByTagName('monster');

            allMonsters = [];
            Array.from(monsters).forEach(monster => {
                const monsterData = {
                    name: getElementText(monster, 'name'),
                    size: getElementText(monster, 'size'),
                    type: getElementText(monster, 'type'),
                    alignment: getElementText(monster, 'alignment'),
                    ac: getElementText(monster, 'ac'),
                    hp: getElementText(monster, 'hp'),
                    speed: getElementText(monster, 'speed'),
                    str: getElementText(monster, 'str'),
                    dex: getElementText(monster, 'dex'),
                    con: getElementText(monster, 'con'),
                    int: getElementText(monster, 'int'),
                    wis: getElementText(monster, 'wis'),
                    cha: getElementText(monster, 'cha'),
                    save: getElementText(monster, 'save'),
                    skill: getElementText(monster, 'skill'),
                    resist: getElementText(monster, 'resist'),
                    vulnerable: getElementText(monster, 'vulnerable'),
                    immune: getElementText(monster, 'immune'),
                    conditionImmune: getElementText(monster, 'conditionImmune'),
                    senses: getElementText(monster, 'senses'),
                    passive: getElementText(monster, 'passive'),
                    languages: getElementText(monster, 'languages'),
                    cr: getElementText(monster, 'cr'),
                    traits: getTraitsOrActions(monster, 'trait'),
                    actions: getTraitsOrActions(monster, 'action'),
                    legendary: getTraitsOrActions(monster, 'legendary'),
                    reactions: getTraitsOrActions(monster, 'reaction'),
                    description: getElementText(monster, 'description')
                };
                allMonsters.push(monsterData);
            });

            displayMonsters(allMonsters);
            loadingMessage.classList.add('hidden');
            
            const savedInfo = document.createElement('div');
            savedInfo.className = 'bg-green-50 border border-green-200 p-3 rounded-lg mb-4 text-sm';
            savedInfo.innerHTML = `
                <p class="text-green-800 font-medium">✓ Database caricato con successo</p>
                <p class="text-green-600 text-xs mt-1">${allMonsters.length} mostri disponibili</p>
            `;
            monsterGrid.parentElement.insertBefore(savedInfo, monsterGrid);
        }

        function getElementText(parent, tagName) {
            const elem = parent.getElementsByTagName(tagName)[0];
            return elem ? elem.textContent.trim() : '';
        }

        function getTraitsOrActions(parent, tagName) {
            const items = parent.getElementsByTagName(tagName);
            return Array.from(items).map(item => {
                const name = getElementText(item, 'name');
                const text = getElementText(item, 'text');
                const attack = getElementText(item, 'attack');
                return { name, text, attack };
            });
        }

        function displayMonsters(monsters) {
            monsterGrid.innerHTML = '';
            if (monsters.length === 0) {
                monsterGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">Nessun mostro trovato.</p>';
                return;
            }

            const sortedMonsters = [...monsters].sort((a, b) => a.name.localeCompare(b.name, 'it', { sensitivity: 'base' }));

            sortedMonsters.forEach(monster => {
                const card = createMonsterCard(monster);
                monsterGrid.appendChild(card);
            });
        }

        function createMonsterCard(monster) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer p-4';
            
            const xp = crXpMap[monster.cr] || 0;
            
            card.innerHTML = `
                <h3 class="text-lg font-bold text-gray-900 mb-2">${monster.name}</h3>
                <p class="text-sm text-gray-600"><strong>Tipo:</strong> ${monster.type}</p>
                <p class="text-sm text-gray-600"><strong>GS:</strong> ${monster.cr} (${xp} PE)</p>
                <p class="text-sm text-gray-600"><strong>CA:</strong> ${monster.ac}</p>
                <p class="text-sm text-gray-600"><strong>PF:</strong> ${monster.hp}</p>
            `;
            
            card.addEventListener('click', () => openModal(monster));
            return card;
        }

        function highlightValues(text) {
            if (!text) return text;
            
            text = text.replace(/\b(\d+)\s*(?:\([^)]+\))?(?=\s|$|,|\.)/g, '<span class="highlight-value">$1</span>');
            
            return text;
        }
        
        function highlightCombatText(text) {
            if (!text) return text;
            
            text = text.replace(/(\+\d+)\s+(?:per colpire|to hit)/gi, '<span class="highlight-bonus">$1</span> per colpire');
            
            text = text.replace(/(\d+d\d+(?:\s*[+\-]\s*\d+)?)\s+(?:danni?|damage)/gi, '<span class="highlight-damage">$1</span> danni');
            text = text.replace(/(\d+)\s+(?:\([\d+d\s+-]+\))?\s*(da?\s+)?(?:fuoco|freddo|acido|elettrico|tuono|forza|necrotico|radiante|veleno|psichico|contundente|perforante|tagliente|contundenti|perforanti|taglienti)/gi, 
                '<span class="highlight-damage">$1</span> $2$3');
            
            text = text.replace(/(?:CD|DC)\s*(\d+)/gi, 'CD <span class="highlight-value">$1</span>');
            
            return text;
        }

        function openModal(monster) {
            currentMonster = monster;
            modalName.textContent = monster.name;
            
            const xp = crXpMap[monster.cr] || 0;
            
            let html = `
                <div class="space-y-2">
                    <p><strong>Taglia:</strong> ${monster.size}</p>
                    <p><strong>Tipo:</strong> ${monster.type}</p>
                    <p><strong>Allineamento:</strong> ${monster.alignment}</p>
                    <hr>
                    <p><strong>Classe Armatura:</strong> ${highlightValues(monster.ac)}</p>
                    <p><strong>Punti Ferita:</strong> ${highlightValues(monster.hp)}</p>
                    <p><strong>Velocità:</strong> ${monster.speed}</p>
                    <hr>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
                        <p><strong>FOR:</strong> ${monster.str}</p>
                        <p><strong>DES:</strong> ${monster.dex}</p>
                        <p><strong>COS:</strong> ${monster.con}</p>
                        <p><strong>INT:</strong> ${monster.int}</p>
                        <p><strong>SAG:</strong> ${monster.wis}</p>
                        <p><strong>CAR:</strong> ${monster.cha}</p>
                    </div>
                    <hr>
            `;
            
            if (monster.save) html += `<p><strong>Tiri Salvezza:</strong> ${highlightCombatText(monster.save)}</p>`;
            if (monster.skill) html += `<p><strong>Abilità:</strong> ${highlightCombatText(monster.skill)}</p>`;
            if (monster.resist) html += `<p><strong>Resistenze:</strong> ${monster.resist}</p>`;
            if (monster.vulnerable) html += `<p><strong>Vulnerabilità:</strong> ${monster.vulnerable}</p>`;
            if (monster.immune) html += `<p><strong>Immunità:</strong> ${monster.immune}</p>`;
            if (monster.conditionImmune) html += `<p><strong>Immunità alle Condizioni:</strong> ${monster.conditionImmune}</p>`;
            if (monster.senses) html += `<p><strong>Sensi:</strong> ${monster.senses}</p>`;
            if (monster.languages) html += `<p><strong>Linguaggi:</strong> ${monster.languages}</p>`;
            
            html += `<p><strong>Grado di Sfida:</strong> ${monster.cr} (${xp} PE)</p>`;
            
            if (monster.traits.length > 0) {
                html += '<h3>Tratti</h3>';
                monster.traits.forEach(trait => {
                    html += `<p><strong>${trait.name}.</strong> ${highlightCombatText(trait.text)}</p>`;
                });
            }
            
            if (monster.actions.length > 0) {
                html += '<h3>Azioni</h3>';
                monster.actions.forEach(action => {
                    let actionText = highlightCombatText(action.text);
                    let attackText = action.attack ? highlightCombatText(action.attack) : '';
                    
                    html += `<p><strong>${action.name}.</strong> ${actionText}`;
                    if (attackText) html += ` <em>${attackText}</em>`;
                    html += '</p>';
                });
            }
            
            if (monster.reactions.length > 0) {
                html += '<h3>Reazioni</h3>';
                monster.reactions.forEach(reaction => {
                    html += `<p><strong>${reaction.name}.</strong> ${highlightCombatText(reaction.text)}</p>`;
                });
            }
            
            if (monster.legendary.length > 0) {
                html += '<h3>Azioni Leggendarie</h3>';
                monster.legendary.forEach(leg => {
                    html += `<p><strong>${leg.name}.</strong> ${highlightCombatText(leg.text)}</p>`;
                });
            }
            
            html += '</div>';
            
            modalContent.innerHTML = html;
            const addToFolderContainer = document.getElementById('add-to-folder-container');

            if (currentFolderViewId) {
                addToTempFolderBtn.parentElement.classList.add('hidden');
                addToFolderContainer.classList.add('hidden');
            } else {
                addToTempFolderBtn.parentElement.classList.remove('hidden');
                addToFolderContainer.classList.remove('hidden');
            }

            history.pushState({ modalOpen: true }, "Dettagli Mostro");

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            modal.classList.add('hidden');
            currentMonster = null;
            document.body.style.overflow = '';

            if (history.state && history.state.modalOpen) {
                history.back();
            }
        }

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        function applyFilters() {
            const nameQuery = filterInput.value.toLowerCase();
            const crQuery = crFilterSelect.value;

            const filtered = allMonsters.filter(m => {
                const nameMatch = nameQuery === '' ||
                                  m.name.toLowerCase().includes(nameQuery) ||
                                  m.type.toLowerCase().includes(nameQuery);
                
                const crMatch = crQuery === '' || m.cr === crQuery;

                return nameMatch && crMatch;
            });

            displayMonsters(filtered);
        }

        filterInput.addEventListener('input', applyFilters);
        crFilterSelect.addEventListener('change', applyFilters);

        function loadFolders() {
            if (!userId) return;
            
            if (useLocalStorage) {
                const savedFolders = localStorage.getItem('dnd-folders');
                folders = savedFolders ? JSON.parse(savedFolders) : {};
                updateFolderUI();
                if (currentFolderViewId && folders[currentFolderViewId]) {
                    viewFolder(currentFolderViewId);
                }
                return;
            }
            
            const foldersRef = collection(db, `apps/${appId}/users/${userId}/folders`);
            onSnapshot(foldersRef, (snapshot) => {
                folders = {};
                
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    folders[docSnap.id] = { ...data, id: docSnap.id };
                });
                
                updateFolderUI();
                if (currentFolderViewId && folders[currentFolderViewId]) {
                    viewFolder(currentFolderViewId);
                }
            });
        }

        function updateFolderUI() {
            folderList.innerHTML = '';
            addToFolderSelect.innerHTML = '<option value="">Scegli cartella...</option>';
            
            Object.keys(folders).forEach((folderId) => {
                const data = folders[folderId];
                
                const li = document.createElement('li');
                li.className = 'bg-gray-100 p-3 rounded-lg hover:bg-gray-200 cursor-pointer flex justify-between items-center';
                li.innerHTML = `
                    <span class="font-medium">${data.name}</span>
                    <button class="text-red-500 hover:text-red-700" data-folder-id="${folderId}">
                        <ion-icon name="trash-outline"></ion-icon>
                    </button>
                `;
                
                li.addEventListener('click', () => {
                    viewFolder(folderId);
                    if (window.innerWidth < 768) closeSidebarMenu();
                });
                
                li.querySelector('button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteFolder(folderId);
                });
                
                folderList.appendChild(li);
                
                const option = document.createElement('option');
                option.value = folderId;
                option.textContent = data.name;
                addToFolderSelect.appendChild(option);
            });
            
            if (Object.keys(folders).length > 0) {
                showAllBtn.classList.remove('hidden');
            }
        }

        async function createFolder() {
            const name = newFolderInput.value.trim();
            if (!name || !userId) return;
            
            if (useLocalStorage) {
                const newId = 'folder_' + Date.now();
                folders[newId] = {
                    id: newId,
                    name,
                    monsters: [],
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('dnd-folders', JSON.stringify(folders));
                updateFolderUI();
                newFolderInput.value = '';
                showToast('Cartella creata!');
                return;
            }
            
            try {
                await addDoc(collection(db, `apps/${appId}/users/${userId}/folders`), {
                    name,
                    monsters: [],
                    createdAt: serverTimestamp()
                });
                newFolderInput.value = '';
                showToast('Cartella creata!');
            } catch (error) {
                console.error("Errore creazione cartella:", error);
                showToast('Errore nella creazione della cartella');
            }
        }

        async function deleteFolder(folderId) {
            if (!confirm('Eliminare questa cartella?')) return;
            
            if (useLocalStorage) {
                delete folders[folderId];
                localStorage.setItem('dnd-folders', JSON.stringify(folders));
                updateFolderUI();
                showToast('Cartella eliminata');
                return;
            }
            
            try {
                await deleteDoc(doc(db, `apps/${appId}/users/${userId}/folders/${folderId}`));
                showToast('Cartella eliminata');
            } catch (error) {
                console.error("Errore eliminazione:", error);
            }
        }

        function viewFolder(folderId) {
            const folder = folders[folderId];
            if (!folder) return;
            
            currentFolderViewId = folderId;
            
            const monsterCounts = {};
            const monsterNames = folder.monsters || [];
            monsterNames.forEach(name => {
                monsterCounts[name] = (monsterCounts[name] || 0) + 1;
            });
            
            displayFolderMonsters(monsterCounts);
            
            const totalXp = monsterNames.reduce((sum, name) => {
                const monster = allMonsters.find(m => m.name === name);
                return sum + (monster ? (crXpMap[monster.cr] || 0) : 0);
            }, 0);
            
            folderInfoBar.classList.remove('hidden');
            folderInfoName.textContent = folder.name;
            folderInfoXp.textContent = `XP Totale: ${totalXp.toLocaleString()}`;
        }
        
        function displayFolderMonsters(monsterCounts) {
            monsterGrid.innerHTML = '';
            
            if (Object.keys(monsterCounts).length === 0) {
                monsterGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">Nessun mostro in questa cartella.</p>';
                return;
            }
            
            const sortedEntries = Object.entries(monsterCounts).sort((a, b) => a[0].localeCompare(b[0], 'it', { sensitivity: 'base' }));

            sortedEntries.forEach(([name, count]) => {
                const monster = allMonsters.find(m => m.name === name);
                if (!monster) return;
                
                const card = createFolderMonsterCard(monster, count);
                monsterGrid.appendChild(card);
            });
        }
        
        function createFolderMonsterCard(monster, count) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow p-4';
            
            const xp = crXpMap[monster.cr] || 0;
            const totalXp = xp * count;
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-lg font-bold text-gray-900 flex-1 cursor-pointer hover:text-blue-600" data-monster-name="${monster.name}">${monster.name}</h3>
                    <span class="bg-blue-100 text-blue-800 text-sm font-semibold px-2.5 py-0.5 rounded ml-2">x${count}</span>
                </div>
                <p class="text-sm text-gray-600"><strong>Tipo:</strong> ${monster.type}</p>
                <p class="text-sm text-gray-600"><strong>GS:</strong> ${monster.cr} (${xp} PE)</p>
                <p class="text-sm text-gray-600"><strong>CA:</strong> ${monster.ac}</p>
                <p class="text-sm text-gray-600"><strong>PF:</strong> ${monster.hp}</p>
                <p class="text-sm font-semibold text-blue-700 mt-2">PE Totali: ${totalXp.toLocaleString()}</p>
                
                <div class="flex gap-2 mt-3">
                    <button class="decrease-btn flex-1 bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 font-medium" data-monster-name="${monster.name}">
                        <ion-icon name="remove" class="align-middle"></ion-icon>
                    </button>
                    <button class="increase-btn flex-1 bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 font-medium" data-monster-name="${monster.name}">
                        <ion-icon name="add" class="align-middle"></ion-icon>
                    </button>
                </div>
            `;
            
            card.addEventListener('click', () => {
                openModal(monster);
            });
            
            card.querySelector('.decrease-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                updateMonsterCount(monster.name, -1);
            });
            
            card.querySelector('.increase-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                updateMonsterCount(monster.name, 1);
            });
            
            return card;
        }
        
        async function updateMonsterCount(monsterName, delta) {
            if (!currentFolderViewId) return;
            
            const folder = folders[currentFolderViewId];
            let monsters = [...(folder.monsters || [])];
            
            if (delta > 0) {
                monsters.push(monsterName);
                showToast(`${monsterName} aggiunto`);
            } else {
                const index = monsters.indexOf(monsterName);
                if (index > -1) {
                    monsters.splice(index, 1);
                    showToast(`${monsterName} rimosso`);
                }
            }
            
            if (useLocalStorage) {
                folders[currentFolderViewId].monsters = monsters;
                localStorage.setItem('dnd-folders', JSON.stringify(folders));
                viewFolder(currentFolderViewId);
            } else {
                try {
                    await updateDoc(doc(db, `apps/${appId}/users/${userId}/folders/${currentFolderViewId}`), {
                        monsters
                    });
                } catch (error) {
                    console.error("Errore aggiornamento conteggio:", error);
                    showToast('Errore nell\'aggiornamento');
                }
            }
        }

        showAllBtn.addEventListener('click', () => {
            currentFolderViewId = null;
            displayMonsters(allMonsters);
            folderInfoBar.classList.add('hidden');
        });

        createFolderBtn.addEventListener('click', createFolder);
        newFolderInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createFolder();
        });

        addToFolderSelect.addEventListener('change', async (e) => {
            const folderId = e.target.value;
            if (!folderId || !currentMonster) return;
            
            const folder = folders[folderId];
            const monsters = folder.monsters || [];
            
            if (!monsters.includes(currentMonster.name)) {
                monsters.push(currentMonster.name);
                
                if (useLocalStorage) {
                    folders[folderId].monsters = monsters;
                    localStorage.setItem('dnd-folders', JSON.stringify(folders));
                    showToast(`${currentMonster.name} aggiunto a ${folder.name}`);
                } else {
                    try {
                        await updateDoc(doc(db, `apps/${appId}/users/${userId}/folders/${folderId}`), {
                            monsters
                        });
                        showToast(`${currentMonster.name} aggiunto a ${folder.name}`);
                    } catch (error) {
                        console.error("Errore aggiunta mostro:", error);
                    }
                }
            } else {
                showToast('Mostro già presente in questa cartella');
            }
            
            e.target.value = '';
        });

        function updateTempFolderUI() {
            tempFolderList.innerHTML = '';
            tempMonsterList.forEach(name => {
                const li = document.createElement('li');
                li.className = 'text-sm text-gray-700 flex justify-between items-center';
                li.innerHTML = `
                    <span>${name}</span>
                    <button class="text-red-500 hover:text-red-700 text-xs" data-remove="${name}">
                        <ion-icon name="close-circle"></ion-icon>
                    </button>
                `;
                
                li.querySelector('button').addEventListener('click', () => {
                    tempMonsterList = tempMonsterList.filter(n => n !== name);
                    updateTempFolderUI();
                });
                
                tempFolderList.appendChild(li);
            });
        }

        addToTempFolderBtn.addEventListener('click', () => {
            if (!currentMonster) return;
            
            if (!tempMonsterList.includes(currentMonster.name)) {
                tempMonsterList.push(currentMonster.name);
                updateTempFolderUI();
                showToast(`${currentMonster.name} aggiunto alla selezione`);
            } else {
                showToast('Mostro già nella selezione');
            }
        });

        clearTempFolderBtn.addEventListener('click', () => {
            tempMonsterList = [];
            tempFolderInput.value = '';
            updateTempFolderUI();
            showToast('Selezione svuotata');
        });

        saveTempFolderBtn.addEventListener('click', async () => {
            const name = tempFolderInput.value.trim();
            if (!name || tempMonsterList.length === 0) {
                showToast('Inserisci un nome e seleziona almeno un mostro');
                return;
            }
            
            if (useLocalStorage) {
                const newId = 'folder_' + Date.now();
                folders[newId] = {
                    id: newId,
                    name,
                    monsters: [...tempMonsterList],
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('dnd-folders', JSON.stringify(folders));
                updateFolderUI();
                tempMonsterList = [];
                tempFolderInput.value = '';
                updateTempFolderUI();
                showToast('Cartella salvata!');
                return;
            }
            
            try {
                await addDoc(collection(db, `apps/${appId}/users/${userId}/folders`), {
                    name,
                    monsters: [...tempMonsterList],
                    createdAt: serverTimestamp()
                });
                
                tempMonsterList = [];
                tempFolderInput.value = '';
                updateTempFolderUI();
                showToast('Cartella salvata!');
            } catch (error) {
                console.error("Errore salvataggio:", error);
                showToast('Errore nel salvataggio');
            }
        });

        function showToast(message) {
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        clearDbBtn.addEventListener('click', async () => {
            if (!indexedDBAvailable) {
                showToast('Salvataggio locale non disponibile');
                return;
            }
            
            if (confirm('Eliminare il database salvato? Dovrai ricaricare il file XML.')) {
                try {
                    await clearSavedMonsters();
                    allMonsters = [];
                    displayMonsters([]);
                    dbStatus.textContent = 'Database eliminato. Carica un file XML.';
                    dbStatus.className = 'mt-2 text-xs text-gray-500';
                    clearDbBtn.classList.add('hidden');
                    loadingMessage.classList.remove('hidden');
                    loadingMessage.textContent = 'Carica il file XML per iniziare';
                    showToast('Database eliminato');
                } catch (error) {
                    console.error('Errore eliminazione:', error);
                    showToast('Errore durante l\'eliminazione');
                }
            }
        });

        function populateCrFilter() {
            Object.keys(crXpMap).forEach(cr => {
                const option = document.createElement('option');
                option.value = cr;
                option.textContent = cr;
                crFilterSelect.appendChild(option);
            });
        }

        async function initApp() {
            console.log('Inizializzazione app...');
            
            populateCrFilter();
            
            try {
                await initIndexedDB();
                console.log('✓ IndexedDB inizializzato correttamente');
                
                try {
                    const savedMonsters = await loadMonstersFromIndexedDB();
                    if (savedMonsters && savedMonsters.length > 0) {
                        allMonsters = savedMonsters;
                        displayMonsters(allMonsters);
                        loadingMessage.classList.add('hidden');
                        dbStatus.textContent = `✓ ${allMonsters.length} mostri caricati dal database locale`;
                        dbStatus.className = 'mt-2 text-xs text-green-600 font-medium';
                        clearDbBtn.classList.remove('hidden');
                        showToast('Database caricato automaticamente!');
                        console.log('✓ Mostri caricati da IndexedDB');
                    } else {
                        dbStatus.textContent = 'Nessun database salvato. Carica un file XML.';
                        dbStatus.className = 'mt-2 text-xs text-gray-500';
                        console.log('ℹ Nessun dato salvato in IndexedDB');
                    }
                } catch (loadError) {
                    console.error('Errore caricamento da IndexedDB:', loadError);
                    dbStatus.textContent = 'Errore caricamento database. Carica un file XML.';
                    dbStatus.className = 'mt-2 text-xs text-orange-600';
                }
            } catch (initError) {
                console.error('Errore inizializzazione IndexedDB:', initError);
                indexedDBAvailable = false;
                dbStatus.textContent = '
